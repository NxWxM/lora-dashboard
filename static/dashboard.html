<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Live Sensor Data — Underground Safety</title>
<style>
  :root {
    --bg-1:#070708; --bg-2:#0f1316; --muted:#bfc9cc;
    --accent:#00bcd4; --accent-2:#00e5ff;
    --good:#28a745; --warn:#ffc107; --bad:#ff5252;
  }
  body {
    font-family:"Poppins","Segoe UI",sans-serif;
    background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
    color:var(--muted); margin:0; padding:20px;
  }
  .topbar {
    display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;
  }
  h1 { color:var(--accent-2); font-size:1.2rem; margin:0; }
  .btn {
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    color:#041014; border:none; padding:8px 14px; border-radius:10px; font-weight:600;
    cursor:pointer;
  }
  .dot {
    width:12px; height:12px; border-radius:50%;
    display:inline-block; margin-right:6px;
  }
  .connected { background:var(--good); }
  .disconnected { background:var(--bad); }
  .container {
    max-width:1200px; margin:auto;
    display:grid; grid-template-columns: 1fr 360px; gap:20px;
  }
  .feed {
    border:1px solid rgba(255,255,255,0.05);
    border-radius:12px; padding:14px; min-height:60vh;
  }
  ul#list {
    list-style:none; padding:0; margin:0;
    display:flex; flex-direction:column; gap:14px;
  }
  li.data-card {
    display:flex; justify-content:space-between; align-items:center;
    padding:16px 20px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.05);
    border-radius:12px;
    width:100%;
    box-sizing:border-box;
  }
  .left { display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
  .badge-timestamp {
    font-size:0.85rem; color:#91b7bb;
  }
  .values {
    display:flex; gap:12px; flex-wrap:nowrap;
    justify-content:space-between;
  }
  .chip {
    background:rgba(255,255,255,0.05);
    border-radius:8px;
    padding:8px 14px;
    font-size:1rem;
    min-width:90px;
    text-align:center;
  }
  .label {
    margin-left:10px;
    color:#eafafa;
    font-weight:600;
  }
  .count {
    padding:8px 14px;
    border-radius:8px;
    font-weight:700;
    color:#fff;
  }
  @media (max-width:900px){
    .container { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<div class="topbar">
  <h1>LoRa Safety — Live Feed</h1>
  <div>
    <span id="connDot" class="dot disconnected"></span>
    <span id="connText">Disconnected</span>
    <button id="clearBtn" class="btn">Clear</button>
  </div>
</div>

<div class="container">
  <section class="feed">
    <ul id="list"></ul>
    <div id="empty" style="text-align:center;color:#777;padding:20px">No data yet...</div>
  </section>
</div>

<script>
const MAX_ITEMS = 60;
const ul = document.getElementById('list');
const empty = document.getElementById('empty');
const connDot = document.getElementById('connDot');
const connText = document.getElementById('connText');

const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
const wsUrl = `${protocol}//${window.location.host}/ws`;
const ws = new WebSocket(wsUrl);

function setConnected(ok){
  connDot.classList.toggle('connected',ok);
  connDot.classList.toggle('disconnected',!ok);
  connText.textContent = ok ? "Connected" : "Disconnected";
}
ws.onopen=()=>setConnected(true);
ws.onclose=()=>setConnected(false);
ws.onerror=(e)=>console.error("ws error",e);

ws.onmessage = evt=>{
  try{
    const obj=JSON.parse(evt.data);
    const s1=Number(obj.sen_1), s2=Number(obj.sen_2),
          s3=Number(obj.sen_3), s4=Number(obj.sen_4),
          s5=Number(obj.sen_5);
    const label=obj.label||'—';
    const li=document.createElement('li');
    li.className='data-card';
    const timeStr=new Date().toLocaleTimeString();

    li.innerHTML=`
      <div class="left">
        <div class="badge-timestamp">${timeStr}</div>
        <div class="values">
          <div class="chip">S1<br><b>${s1}</b></div>
          <div class="chip">S2<br><b>${s2}</b></div>
          <div class="chip">S3<br><b>${s3}</b></div>
          <div class="chip">S4<br><b>${s4}</b></div>
          <div class="chip">S5<br><b>${s5}</b></div>
        </div>
        <div class="label">Label: ${label}</div>
      </div>
      <div class="count">OK</div>`;
    ul.prepend(li);
    empty.style.display='none';
    if(ul.children.length>MAX_ITEMS) ul.removeChild(ul.lastChild);
  }catch(e){console.error(e);}
};
document.getElementById('clearBtn').onclick=()=>{
  ul.innerHTML=''; empty.style.display='block';
};
</script>

</body>
</html>
